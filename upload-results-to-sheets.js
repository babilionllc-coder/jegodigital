const { GoogleSpreadsheet } = require('google-spreadsheet');
const { JWT } = require('google-auth-library');
const fs = require('fs');

// Load configurations
const googleConfig = JSON.parse(fs.readFileSync('google-service-account-config.json', 'utf8'));

class ResultsUploader {
    constructor() {
        this.doc = null;
        this.serviceAccountAuth = new JWT({
            email: googleConfig.client_email,
            key: googleConfig.private_key,
            scopes: [
                'https://www.googleapis.com/auth/spreadsheets',
                'https://www.googleapis.com/auth/drive.file',
            ],
        });
    }

    async initialize() {
        console.log('üîß Initializing Results Uploader...');
        
        // Initialize Google Sheets
        this.doc = new GoogleSpreadsheet('1nzknj5DlU_1oXeu_7VcMRD6_FRcSkgef2I0ObXxYoLg', this.serviceAccountAuth);
        await this.doc.loadInfo();
        console.log(`üìä Connected to: ${this.doc.title}`);
    }

    async createAnalysisSheet() {
        console.log('üìã Creating/updating analysis sheet...');
        
        let analysisSheet;
        try {
            analysisSheet = this.doc.sheetsByTitle['AI Analysis Results'];
            console.log('‚úÖ Found existing AI Analysis Results sheet');
        } catch (error) {
            console.log('üìù Creating new AI Analysis Results sheet...');
            analysisSheet = await this.doc.addSheet({
                title: 'AI Analysis Results',
                headerRow: 1
            });
        }

        // Load the sheet to ensure it's accessible
        await analysisSheet.loadCells();
        
        // Set headers
        await analysisSheet.loadCells('A1:O1');
        const headers = [
            'Business Name',
            'Phone Number',
            'Location',
            'Industry',
            'Has Website',
            'Business Type',
            'Google Maps Listed',
            'Google Maps Rating',
            'Google Maps Reviews',
            'Issues Found',
            'AI Personalized Message',
            'Analysis Date',
            'Generated By',
            'Status',
            'Notes'
        ];

        for (let i = 0; i < headers.length; i++) {
            const cell = analysisSheet.getCell(0, i);
            cell.value = headers[i];
            cell.textFormat = { bold: true };
        }

        await analysisSheet.saveUpdatedCells();
        console.log('‚úÖ Headers set');
        
        return analysisSheet;
    }

    async uploadResults() {
        console.log('üì§ Uploading analysis results to Google Sheets...');
        
        // Check if results file exists
        if (!fs.existsSync('batch-analysis-results.json')) {
            console.log('‚ùå No batch analysis results found. Please run the batch analyzer first.');
            return;
        }

        // Load results
        const results = JSON.parse(fs.readFileSync('batch-analysis-results.json', 'utf8'));
        console.log(`üìä Found ${results.length} results to upload`);

        // Create or get analysis sheet
        const analysisSheet = await this.createAnalysisSheet();
        
        // Clear existing data (except headers)
        await analysisSheet.clear('A2:O1000');
        
        // Upload results
        for (let i = 0; i < results.length; i++) {
            const result = results[i];
            const rowIndex = i + 2; // Start from row 2 (after headers)
            
            await analysisSheet.loadCells(`A${rowIndex}:O${rowIndex}`);
            
            // Set values
            analysisSheet.getCell(rowIndex - 1, 0).value = result.businessName || '';
            analysisSheet.getCell(rowIndex - 1, 1).value = result.phoneNumber || 'Not provided';
            analysisSheet.getCell(rowIndex - 1, 2).value = result.location || '';
            analysisSheet.getCell(rowIndex - 1, 3).value = result.industry || '';
            analysisSheet.getCell(rowIndex - 1, 4).value = result.websiteAnalysis?.hasWebsite ? 'YES' : 'NO';
            analysisSheet.getCell(rowIndex - 1, 5).value = result.websiteAnalysis?.businessType || 'Unknown';
            analysisSheet.getCell(rowIndex - 1, 6).value = result.mapsAnalysis?.isListed ? 'YES' : 'NO';
            analysisSheet.getCell(rowIndex - 1, 7).value = result.mapsAnalysis?.rating || 'N/A';
            analysisSheet.getCell(rowIndex - 1, 8).value = result.mapsAnalysis?.reviewCount || 0;
            analysisSheet.getCell(rowIndex - 1, 9).value = result.websiteAnalysis?.issues?.length + result.mapsAnalysis?.issues?.length || 0;
            
            // Truncate message if too long
            const message = result.personalizedMessage || '';
            const truncatedMessage = message.length > 2000 ? message.substring(0, 2000) + '...' : message;
            analysisSheet.getCell(rowIndex - 1, 10).value = truncatedMessage;
            
            analysisSheet.getCell(rowIndex - 1, 11).value = result.timestamp || new Date().toISOString();
            analysisSheet.getCell(rowIndex - 1, 12).value = 'ChatGPT-4';
            analysisSheet.getCell(rowIndex - 1, 13).value = 'Ready for Outreach';
            analysisSheet.getCell(rowIndex - 1, 14).value = 'AI Generated Message';
            
            await analysisSheet.saveUpdatedCells();
            
            console.log(`‚úÖ Uploaded ${i + 1}/${results.length}: ${result.businessName}`);
        }

        console.log(`üéâ Successfully uploaded ${results.length} results to Google Sheets!`);
        console.log('üìä Check the "AI Analysis Results" sheet for all your personalized messages');
    }

    async updateOriginalLeadsSheet() {
        console.log('üîÑ Updating original leads sheet with analysis status...');
        
        try {
            const leadsSheet = this.doc.sheetsByTitle['REAL Perfect Leads'];
            await leadsSheet.loadCells();
            
            const rows = await leadsSheet.getRows();
            const results = JSON.parse(fs.readFileSync('batch-analysis-results.json', 'utf8'));
            
            let updatedCount = 0;
            
            for (let i = 0; i < rows.length && i < results.length; i++) {
                const row = rows[i];
                const result = results[i];
                
                if (row.get('Business Name') === result.businessName) {
                    row.set('AI_ANALYZED', 'YES');
                    row.set('WEBSITE_ANALYSIS', result.websiteAnalysis?.hasWebsite ? 'HAS_WEBSITE' : 'NO_WEBSITE');
                    row.set('GOOGLE_MAPS', result.mapsAnalysis?.isListed ? 'LISTED' : 'NOT_LISTED');
                    row.set('BUSINESS_TYPE', result.websiteAnalysis?.businessType || 'Unknown');
                    row.set('ISSUES_FOUND', result.websiteAnalysis?.issues?.length + result.mapsAnalysis?.issues?.length || 0);
                    row.set('AI_PERSONALIZED_MESSAGE', result.personalizedMessage || '');
                    row.set('ANALYSIS_DATE', result.timestamp || new Date().toISOString());
                    row.set('MESSAGE_GENERATED_BY', 'ChatGPT-4');
                    
                    await row.save();
                    updatedCount++;
                }
            }
            
            console.log(`‚úÖ Updated ${updatedCount} leads in original sheet`);
            
        } catch (error) {
            console.log(`‚ùå Error updating original sheet: ${error.message}`);
        }
    }
}

// Main execution
async function main() {
    const uploader = new ResultsUploader();
    
    try {
        await uploader.initialize();
        await uploader.uploadResults();
        await uploader.updateOriginalLeadsSheet();
        
        console.log('\nüéâ ALL RESULTS UPLOADED TO GOOGLE SHEETS!');
        console.log('üìä Check your Google Sheets for:');
        console.log('   - "AI Analysis Results" sheet with all messages');
        console.log('   - "REAL Perfect Leads" sheet updated with analysis status');
        
    } catch (error) {
        console.error('‚ùå Error during upload:', error);
    }
}

if (require.main === module) {
    main();
}

module.exports = ResultsUploader;
